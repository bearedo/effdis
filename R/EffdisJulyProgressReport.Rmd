---
title: A MODELING APPROACH TO ESTIMATE OVERALL ATLANTIC FISHING EFFORT BY TIME-AREA
  STRATA (EFFDIS)
author: "Doug Beare"
date: "14 July 2015"
output: pdf_document
subtitle: Interim Progress Report to the ICCAT secretariat
header-includes: \usepackage{tabularx}
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=7, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

#Executive summary
The Sub-Committee was supportive of the work, approved the outline methodology, and recommended that GCS focus on longline and purse-seine fisheries since by-catch is typically low in baitboat fisheries. It was also suggested that Ghanaian scientists be consulted on the analysis of their purse-seine fisheries which are particularly interesting due to the close working relationships among 'fishing cooperatives' in that country. 


#Introduction
The International Commission for the Conservation of Atlantic Tunas (ICCAT) (www.iccat.int), an intergovernmental organization whose Secretariat headquarters is based in Madrid, Spain, contracted Globefish Consultancy Services (GCS) to develop a statistical modeling approach to estimate overall Atlantic long-line (LL), bait-boat (BB) and purse seine (PS) effort by time-area strata (EFFDIS) that will meet the stated needs of the ICCAT Standing Committee on Research and Statistics (SCRS).  This update of the EFFDIS dataset is critical, especially with regard to by-catch evaluations.  Tangible deliverables are scheduled to take the form of the outputs summarized below.


##Deliverables
1. Detailed descriptions of the methodological approach for SCRS submitted to the ICCAT secretariat.
2. An intermediate report on the status of development of the work as related to LL estimations to be presented to the 2015 Sub Committee on Ecosystems.
3. A progress report on estimations for all fisheries to be presented at the Blue Shark stock assessment session.
4. The development of a comprehensive User Guide and Reference Manuals describing algorithms and code developed. 
5. Provision to the Secretariat of fishing effort and distribution (EFFDIS) estimates (including LL, BB, and PS) for all the main fleets in electronic format (e.g. csv files) compatible with the current ICCAT-DB structures. 
6. An SCRS paper presenting the final estimates with a description of the methods submitted to the 2015 Species group meeting.
7. As part of a continuous process of feedback and comments from the SCRS the contractor will implement any changes requested for final approval.


#Progress and Activities
##Progress toward Deliverables
Detailed descriptions of the methodological approach have been submitted to the ICCAT Secretariat (Deliverable 1). The status of development of the work for LL estimations (Deliverable 2) was presented to the 2015 Sub-Committee on Ecosystems (SCRS/P/2015/026) by Dr L. Kell between June 8 to 12 since GCS were unable to attend. Details are available in the final report here, http://www.iccat.es/en/meetingscurrent.htm and a summary of the recommendations is presented below. The presentation, current report and verbal discussions that took place at the Blue Shark Stock Assessment satisfy the requirements of Deliverable 3. Deliverables 4 - 7 are in progress.

##Recommendations of the Sub-Committee on Ecosystems (SCRS/P/2015/026)
In the past, the Sub-Committee on Ecosystems and the Working Group on Stock Assessment Methods have both made a number of recommendations for updating and improving EFFDIS, which will be incorporated in the new estimates. The Sub-Committee agreed that the EFFDIS data are complex, and difficult to analyse.  GCS has been working to understand the data and identify issues related to non-random, non-representative sampling. All the analysis are being made available on a github repository http://iccat-stats.github.io/. 

It was also clarified that the EFFDIS data are reliant on Task II catch and effort information, and it is known that there are errors in these data. The secretariat said that data screening would take place to eliminate problems such as effort duplication. This revision should reduce the amount of problematic data used for the EFFDIS estimation. The secretariat and GCS are also working to harmonise the very heterogeneous catch and effort data in order to make it comparable, and facilitate its use in the development of EFFDIS. 

It was also discussed that the EFFDIS estimations rely on species composition information (for key target species). This is problematic when applying to by-catch species since the composition is biased towards target species and there are in-consistent historical trends in this bias. GCS is hoping to address this issue using cross-validation although non-random bias remains a complicated problem. The Sub-Committee also requested the addition of southern Bluefin tuna catch information into the estimation of EFFDIS.  

Due to the fact that by-catch information is usually recorded on a set by set basis for purse seine, this unit of effort would be the most appropriate metric in the EFFDIS dataset for this gear. It is not, however, the most frequently reported unit of effort for purse seines, and thus GCS will have to evaluate the practicality of using this metric. 

The Sub-committee also discussed the proposal by the 2013 Working group on stock assessment methods (WGSAM) regarding the additional gears that should be included in the EFFDIS estimation. Previously, it was requested that estimations be done for both purse seine and baitboat fleets. It was pointed out, however, that EFFDIS is only used to assess the fishing impacts of ICCAT fleets on by-catch species, and since by-catch in baitboat fisheries is minimal, there is no point in conducting this exercise for that gear. It was thus agreed that GCS should focus on the more important longline and purse seine estimations under the current contract. 

The Sub-Committee also suggested that, when examining 'fleet profiles' for the purse seine fleet, instead of just separating the effort into 'FAD' or 'Free school fishing', an additional category, namely the Ghanaian purse seine/baitboat co-operative fishery should be considered. This is due to the different catchability apparent for this fleet due to the close co-operation in fishing operations between these two gear types and the sharing of catch, which could bias effort estimates. It was suggested that Ghanaian scientists be consulted to fully explore this unique sector.

##Timeline
The contract between GCS and ICCAT was formally signed by Driss Meski on 26 May 2015. The project is on track to fulfill its objectives and all Deliverables will be finalised within the total 6 months allotted. The original agreed Timetable is duplicated below (Table 1) with comments on progress. 


```{r attach libraries, include =TRUE, echo=FALSE, message=FALSE,error=FALSE,warning=FALSE}
library(rio)
library(spatial)
library(sp)
library(doBy)
library(rgdal)
library(RODBC)
library(RColorBrewer)
library(ggplot2)
library(vmstools)
library(mgcv)
library(maps)
library(mapdata)
library(reshape2)
library(rgeos)
library(lattice)
library(pander)
```

*Table 1. EFFDIS project workplan*
```{r workplan, include =TRUE, echo=FALSE}
workplan <- import('/home/doug/effdis/data/EFFDIS-Workplan.xlsx')
panderOptions("table.split.table",150)
panderOptions("table.alignment.default","left")
pander(workplan)
```

##Data, servers, and version control
An Ubuntu cloud server with a static IP address (134.213.29.249, effdis-tuna-cc1) was set up by the ICCAT Secretariat specifically for the current project. GCS has also set up a PostGIS enabled PostgreSQL server on this machine where all data related to the project are being stored.  The database can be accessed directly from the command line of any unix machine with PostgreSQL installed (psql -h 134.213.29.249 -d effdis -U postgres) or with ODBC via R.  

The effdis-tuna-cc1 server also hosts the online geographic information system being trialled for the EFFDIS project by GCS (http://134.213.29.249/effdis/#).  All scripts (R, Rmarkdown, Shell, PHP) developed by the project are being backed up on GitHub (https://github.com/bearedo/effdis). Furthermore all reports and presentations are being done with Rmarkdown, linked to GitHub. This should all facilitate any future modification and updating.

##Exploratory data analysis
###Data screening

```{r source functions,include=FALSE}
setwd("/home/doug/effdis/R")
source("yr.month.coverage.task2.r")
source("trend.r")
source("spatial.coverage.by.year.task2.r")
source("three.d.effort.by.year.r")
source("three.d.catch.by.year.r")
```

Once the RODBC library is installed and the /etc/odbc.ini file modified to include the effdis database the data can be accessed via R according to the following.


```{r connect to db,include=TRUE}
chan <- odbcConnect("effdis-tuna-cc1", case="postgresql", believeNRows=FALSE)
```

Here is an example of counting the numbers of times each effort type has been recorded in the Task II data for longliners. The table illustrates the problems with these data. Brazil, for example, only supplies 'NO. HOOKS' (9380) while Belize has supplied both 'NO. HOOKS' and 'D.FISH'. Many flags have also supplied no effort data with their Task II submissions.

*Table 2. Effort type sampling by flag in EFFDIS Task II database*
```{r get effort type sampling by flag,include=TRUE,echo=FALSE}
effort_type_by_flag <- sqlQuery(chan, "SELECT flagname AS Flag, eff1type AS Effort_type, count(eff1type) as No_records
                 FROM t2ce_long_format_ll
                 WHERE region ='AT' AND month < 13 AND species ='alb'
                 GROUP BY flagname, eff1type
                 ORDER BY flagname, eff1type, No_records;")
pander(effort_type_by_flag)
```

After examining this table GCS made the decision to examine records with 'NO. HOOKS' and remove all other rows. Similarly there are 3346 data recorded with catch unit '--' (Table 3) and these data were also perforce removed from subsequent analyses.

*Table 3. Catch unit sampling by flag in EFFDIS Task II database*
```{r catch unit sampling by flag,include=TRUE,echo=FALSE}
catchunit_by_flag <- sqlQuery(chan, "SELECT catchunit AS catchunit, count(catchunit) as No_records
                 FROM t2ce_long_format_ll
                 WHERE region ='AT' AND month < 13 AND species ='alb'AND eff1type='NO.HOOKS'
                 GROUP BY catchunit
                 ORDER BY catchunit, No_records;")
pander(catchunit_by_flag)
```

### Catch weights versus numbers

Another problem with the Task II data is the fact that some countries report catches by total weight, some by total numbers and some by both.  The data for countries that have reported both weights and numbers were extracted and examined. The relationships between them proved to be highly linear (Figure 1).

```{r weights versus numbers,include=TRUE,echo=FALSE}
pp0 <- sqlQuery(chan, "SELECT trend, month, flagname, catchunit, species, sum(measured_catch) as measured_catch
FROM t2ce_long_format_ll
WHERE region ='AT' AND month < 13 AND eff1type='NO.HOOKS' AND dsettype = 'nw' AND catchunit != '--'
                 GROUP BY trend,month,flagname,catchunit, species
                 ORDER BY flagname,trend,month;")
# Split into two data frames
pp0_nr <- pp0[pp0$catchunit == 'nr',]
dimnames(pp0_nr)[[2]][6] <- 'measured_catch_nr'
pp0_kg <- pp0[pp0$catchunit == 'kg',]
dimnames(pp0_kg)[[2]][6] <- 'measured_catch_kg'

pp0_kg_nr <- merge(pp0_kg[,-4],pp0_nr[,-4])

xyplot(log(measured_catch_kg)~log(measured_catch_nr)|species,auto.key=TRUE,
       groups=flagname,data=pp0_kg_nr)
```

On the basis of Figure 1 we decided to model the relationship between numbers and weights and use the parameters to impute weights for Task II where total numbers only were supplied. A stepwise model selection procedure resulted in the model summarised below (Table 4). The model fits the data well and the $R^2$ = 90%. Note: that when the bootstrap error variance estimation is done this process will need to be included.

*Table 4. Linear model summarising the relationship between weights and numbers for countries that sent both to ICCAT for the Task II database*

```{r model weights versus numbers,include=TRUE,echo=FALSE}
mod <- step(lm(measured_catch_kg~measured_catch_nr+trend+species+flagname,data=pp0_kg_nr,na.action='na.omit'),direction='both',trace=F)
panderOptions("digits",1)
pander(mod)
#pander(anova(mod))
#pander(summary(mod))
```


### Sampling by year and month

```{r temporal confounding Japan and Chinese Taipei,include=TRUE,echo=FALSE,fig.height=5}
par(mfrow=c(2,2),mar=c(2,2,2,2),oma=c(1,1,1,1))
out <- sqlQuery(chan,"SELECT yearc AS year, trend, timeperiodid AS month, flagname, region, geargrpcode,longitude,latitude, catchunit, dsettype, eff1, eff1type
FROM t2ce
WHERE region ='AT' AND timeperiodid < 13 AND eff1type='NO.HOOKS' AND geargrpcode = 'LL' AND flagname IN ('Japan', 'Chinese Taipei','Brasil', 'U.S.A.','China P.R.') AND catchunit != '--' ;")
yr.month.coverage.task2.r(tdata=out,which.gear='LL',start.year=1960,end.year=2010,which.flag='Japan')
yr.month.coverage.task2.r(tdata=out,which.gear='LL',start.year=1960,end.year=2010,which.flag='Chinese Taipei')
yr.month.coverage.task2.r(tdata=out,which.gear='LL',start.year=1960,end.year=2010,which.flag='Brasil')
yr.month.coverage.task2.r(tdata=out,which.gear='LL',start.year=1960,end.year=2010,which.flag='U.S.A.')

```

## Sampling in space by year - Brazil

```{r spatial confounding Brasil,include=TRUE,echo=FALSE}
par(mfrow=c(4,4),mar=c(0,0,1,0))
spatial.coverage.by.year.task2.r(tdata=out,start.year=1975,end.year=1990,which.gear='LL',which.flag='Brasil')
```

## Sampling in space by year - Japan 

```{r spatial confounding Japan, include=TRUE,echo=FALSE}
par(mfrow=c(4,4),mar=c(0,0,1,0))
spatial.coverage.by.year.task2.r(tdata=out,start.year=1985,end.year=2000,which.gear='LL',which.flag='Japan')
```

## Sampling in space by year - Chinese Taipei

```{r spatial confounding Chinese Taipei, include=TRUE,echo=FALSE}
par(mfrow=c(4,4),mar=c(0,0,1,0))
spatial.coverage.by.year.task2.r(tdata=out,start.year=1995,end.year=2010,which.gear='LL',which.flag='Chinese Taipei')
```

## No of hooks by year and location

```{r no of hooks shot by China P.R. in 2006 from task 2,include=TRUE,echo=FALSE,message = FALSE, error=FALSE, warnings=FALSE}
par(mfrow=c(1,1),mar=c(3,3,3,3))
three.d.effort.by.year.r(tdata=out,what.year=2006,what.flag='China P.R.',scaling.f=10000)  
```


```{r no of hooks shot by Chinese Taipei in 2006 from task 2,include=TRUE,echo=FALSE,message = FALSE, error=FALSE, warnings=FALSE}
three.d.effort.by.year.r(tdata=out,what.year=2006,what.flag='Chinese Taipei',scaling.f=10000)  
```

```{r no of hooks shot by Brasil in 2006 from task 2,include=TRUE,echo=FALSE,message = FALSE, error=FALSE, warnings=FALSE}
three.d.effort.by.year.r(tdata=out,what.year=2006,what.flag='Brasil',scaling.f=10000)  
```

```{r no of hooks shot by USA in 2006 from task 2,include=TRUE,echo=FALSE,message = FALSE, error=FALSE, warnings=FALSE}
three.d.effort.by.year.r(tdata=out,what.year=2006,what.flag='U.S.A.',scaling.f=10000)  
```

## Weight of albacore caught by year and location - China P.R.

```{r kg albacore caught by selected flags in 2006 from task 2,include=TRUE,echo=FALSE,message = FALSE, error=FALSE, warnings=FALSE}

alb <- sqlQuery(chan,"SELECT yearc AS year, trend, timeperiodid AS month, flagname, region, geargrpcode,longitude,latitude, catchunit, dsettype, eff1, eff1type, alb as measured_catch
FROM t2ce
WHERE region ='AT' AND timeperiodid < 13 AND eff1type='NO.HOOKS' AND geargrpcode = 'LL' AND flagname IN ('Japan', 'Chinese Taipei','Brasil', 'U.S.A.','China P.R.') AND catchunit != '--' ;")

alb$species <- 'alb'

source("/home/doug/effdis/R/three.d.catch.by.year.r")
three.d.catch.by.year.r(tdata=alb,what.year=2006,what.species='alb',what.flag='Brasil',scaling.f=100,catchunit='kg')  

three.d.catch.by.year.r(tdata=alb,what.year=2006,what.species='alb',what.flag='Japan',scaling.f=10,catchunit='nr')  

three.d.catch.by.year.r(tdata=alb,what.year=2006,what.species='alb',what.flag='U.S.A.',scaling.f=10,catchunit='nr')  

```

##Regression modeling

```{r regression modeling ,include=TRUE,echo=FALSE,message = FALSE, error=FALSE, warnings=FALSE}

mod.output <- sqlQuery(chan,"SELECT *
FROM t2ce_model
WHERE species = 'alb' AND year = 2006;")

lonnie <- seq(-96.5,18.5,by=5)
lattie <- seq(-56.5,58.5,by=5)
lo<- length(lonnie)
la<- length(lattie)

par(mfrow=c(4,3),mar=c(1,1,2,1),oma=c(0,0,0,0))

for(i in c(1,3,9,11))
  {
  
  grd <- mod.output[mod.output$month == i ,]

  image(lonnie,lattie,matrix(grd$prob,lo,la),col=topo.colors(100),xlab='',ylab='',xaxt='n',yaxt='n')
  contour(lonnie,lattie,matrix(grd$prob,lo,la),col=topo.colors(100),add=T)
  map('worldHires',add=T,fill=T);title(paste('P(catch)',month.abb[i],'2006'))
  
#   image(lonnie,lattie,matrix(log(grd$measured_catch),lo,la),col=topo.colors(100),xlab='',ylab='',xaxt='n',yaxt='n')
#   contour(lonnie,lattie,matrix(log(grd$measured_catch),lo,la),col=topo.colors(100),add=T)
#   map('worldHires',add=T,fill=T);title(paste('Catch without zeros (C1)',month.abb[i],'2006'))
  
  image(lonnie,lattie,matrix(log(grd$catch),lo,la),col=topo.colors(100),xlab='',ylab='',xaxt='n',yaxt='n')
  contour(lonnie,lattie,matrix(log(grd$catch),lo,la),col=topo.colors(100),add=T)
  map('worldHires',add=T,fill=T);title(paste('P x C',month.abb[i],'2006'))
  
image(lonnie,lattie,matrix(grd$eff,lo,la),col=topo.colors(100),xlab='',ylab='',xaxt='n',yaxt='n')
  contour(lonnie,lattie,matrix(log(grd$eff),lo,la),col=topo.colors(100),add=T)
  map('worldHires',add=T,fill=T);title(paste('# hooks',month.abb[i],'2006'))

}

```

## First estimate 

```{r global effort estimate, include=TRUE,echo=FALSE,message = FALSE, error=FALSE, warnings=FALSE}

effdis <- read.table('/home/doug/effdis/data/effdis-estimate.csv',sep=',',header=T)
par(mfrow=c(1,1),mar=c(5,5,4,4))
plot(effdis$year,effdis$effort,xlab='',ylab='hooks',type='l',lwd=3,xlim=c(1960,2010))
abline(v=seq(1960,2010,by=10),lty=2,col='blue')
title('Task 1 Catch / Task 2 CPUE')
```



##Presentations

##Postgresql and PostGIS server


#Conclusions